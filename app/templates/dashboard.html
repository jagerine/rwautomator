<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="color-scheme" content="light dark" />
    <meta
      name="theme-color"
      content="#ffffff"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#121212"
      media="(prefers-color-scheme: dark)"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RealWorld Automation Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css"
    />
    <style>
      @media (prefers-color-scheme: dark) {
        body,
        html {
          background-color: #1a1a1a;
          color: #e0e0e0;
        }
        body {
          margin-bottom: 100px;
        }
        .box {
          background-color: #2a2a2a;
          border: 1px solid #3a3a3a;
          box-shadow: none;
        }
        .title {
          color: #ffffff;
        }
        .subtitle {
          color: #b0b0b0;
        }
        .label {
          color: #d0d0d0;
        }
        .input,
        .textarea {
          background-color: #333333;
          border-color: #4a4a4a;
          color: #e0e0e0;
        }
        .input:focus,
        .textarea:focus {
          border-color: #5a5a5a;
        }
        .help {
          color: #909090;
        }
        .table {
          background-color: #2a2a2a;
          color: #e0e0e0;
        }
        .table thead th {
          color: #ffffff;
          border-color: #4a4a4a;
        }
        .table tbody td {
          border-color: #3a3a3a;
        }
        .tabs li.is-active a {
          border-bottom-color: #3273dc;
          color: #3273dc;
        }
        .tabs a {
          color: #b0b0b0;
        }
        .tabs a:hover {
          color: #e0e0e0;
        }
      }
      h1.title {
        font-weight: 300;
      }
      .container {
        max-width: 1200px;
      }
      .tab-content {
        display: none;
      }
      .tab-content.is-active {
        display: block;
      }
      .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
      }
      .status-pending {
        background-color: #ffe08a;
        color: #947600;
      }
      .status-processing {
        background-color: #8ec5fc;
        color: #1d4e89;
      }
      .status-success {
        background-color: #48c78e;
        color: #257953;
      }
      .status-error,
      .status-failed {
        background-color: #f14668;
        color: #fff;
      }
      @media (prefers-color-scheme: dark) {
        .status-pending {
          background-color: #947600;
          color: #ffe08a;
        }
        .status-processing {
          background-color: #1d4e89;
          color: #8ec5fc;
        }
        .status-success {
          background-color: #257953;
          color: #48c78e;
        }
      }
      #loading-indicator {
        display: none;
        width: 0.75rem;
        height: 0.75rem;
        border: 2px solid #ccc;
        border-top-color: #5d5d5d;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .jobrow-error,
      .jobrow-failed {
        border-top: #550000 2px solid;
        border-bottom: #550000 2px solid;
      }
      .icon-logo-container {
        display: inline-block;
        width: 24px;
      }
      .icon-logo-container svg {
        fill: #aaa;
      }
      button.pagination-link.button.is-current {
        background-color: #2758a8;
        color: #fff;
        border-color: transparent;
      }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <div class="columns">
          <div class="column is-two-thirds">
            <h1 class="title">
              <span class="icon-logo-container">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                  <!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                  <path
                    d="M64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM384 416C384 399.8 378 384.9 368 373.7L437.5 234.8C443.4 222.9 438.6 208.5 426.8 202.6C415 196.7 400.5 201.5 394.6 213.3L325.1 352.2C323.4 352.1 321.7 352 320 352C284.7 352 256 380.7 256 416C256 451.3 284.7 480 320 480C355.3 480 384 451.3 384 416z"
                  />
                </svg>
              </span>

              RealWorld Automator
            </h1>
          </div>
          <div class="column is-one-third has-text-right">
            <span style="display: inline-block; width: 30px; position: relative; top: 5px;">
              <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="circle-user" class="svg-inline--fa fa-circle-user h-4 w-4 mr-2 opacity-75" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M399 384.2C376.9 345.8 335.4 320 288 320l-64 0c-47.4 0-88.9 25.8-111 64.2c35.2 39.2 86.2 63.8 143 63.8s107.8-24.7 143-63.8zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm256 16a72 72 0 1 0 0-144 72 72 0 1 0 0 144z"></path></svg>
            </span>
            <span id="LoggedInAs"></span>
            <button class="button is-small ml-3" onclick="logout()">
              Logout
            </button>
          </div>
        </div>

        <div class="tabs is-boxed">
          <ul>
            <li class="is-active" data-tab="currentjobs">
              <a>
                <span>Current Jobs</span>
              </a>
            </li>
            <li data-tab="resetorders">
              <a>
                <span>Reset Orders</span>
              </a>
            </li>
            <li data-tab="history">
              <a>
                <span>History</span>
              </a>
            </li>
          </ul>
        </div>

        <!-- Current Jobs Tab -->
        <div id="currentjobs-tab" class="tab-content is-active">
          <div class="columns">
            <div class="column"></div>
            <div class="column is-one-quarter">
              <h4 class="subtitle is-6">
                <strong>Last Refresh &nbsp;</strong
                ><span id="last-refresh-time"></span>
                <span id="loading-indicator"></span>
              </h4>
            </div>
          </div>
          <div class="table-container"></div>
        </div>

        <!-- Reset Orders Tab -->
        <div id="resetorders-tab" class="tab-content">
          <div class="columns is-variable is-8">
            <div class="column is-two-thirds">
              <h2 class="subtitle is-5">Batch Order Reset</h2>
              <form id="batch-form">
                <div class="columns">
                  <div class="column is-two-thirds">
                    <div class="field">
                      <!-- Zendesk ticket number  -->
                      <label class="label">Zendesk Ticket Number</label>
                      <div class="control">
                        <input
                          class="input"
                          type="text"
                          id="batch-ticket-number"
                          name="ticket-number"
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="columns">
                  <div class="column">
                    <div class="field">
                      <label class="label">Distribution Center</label>
                      <div class="control">
                        <!-- select: ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10'] -->

                        <select class="input" id="batch-dc" required>
                          <option value="" disabled selected>Select DC</option>
                        </select>
                      </div>
                      <p class="help">Same DC will be used for all orders</p>
                    </div>
                  </div>

                </div>

                <div class="field">
                  <label class="label">Order Numbers</label>
                  <div class="control">
                    <textarea
                      class="textarea"
                      id="batch-orders"
                      placeholder="Enter order numbers, one per line:&#10;557907&#10;557908&#10;557909"
                      rows="5"
                      required
                    ></textarea>
                  </div>
                  <p class="help">
                    Enter one order number per line. Empty lines will be
                    ignored.
                  </p>
                </div>

                <div class="columns">
                  <div class="column is-one-third">
                    <div class="field">
                      <div class="control">
                        <button
                          class="button is-primary"
                          id="BatchResetButton"
                          type="submit"
                        >
                          Reset Batch
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="column is-two-thirds" id="batch-result"></div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content">
          <form id="search-form" class="mb-4">
            <div class="columns">
              <div class="column is-one-quarter">
                <label class="label">Order Search</label>
                <div class="field is-grouped">
                  <div class="control">
                    <input
                      class="input is-small"
                      type="text"
                      id="search-input"
                      placeholder="Order #"
                    />
                  </div>
                  <div class="control">
                    <button
                      class="button is-small"
                      type="button"
                      onclick="orderHistorySearch()"
                    >
                      Search
                    </button>
                  </div>
                </div>
              </div>
              <div class="column is-half">
                <label class="label">Date Range</label>
                <div class="field">
                  <div class="field is-grouped">
                    <div class="control">
                      <input
                        class="input is-small"
                        type="date"
                        id="start-date"
                        placeholder="Start Date"
                      />
                    </div>
                    <div class="control">
                      <input
                        class="input is-small"
                        type="date"
                        id="end-date"
                        placeholder="End Date"
                      />
                    </div>
                    <div class="control">
                      <button
                        class="button is-small"
                        type="button"
                        id="filter-button"
                        onclick="applyFilters()"
                      >
                        Filter
                      </button>
                      <button
                        class="button is-small"
                        type="button"
                        id="clear-filters"
                        onclick="clearFilters()"
                      >
                        Clear
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="column is-one-quarter">
                <button
                  class="button is-small is-info"
                  type="button"
                  onclick="exportSelectedJobs()"
                >
                  Export
                </button>
              </div>
            </div>
          </form>
          <div style="clear: both"></div>

          <div id="history-loading" style="display: none">
            <progress class="progress is-small is-primary" max="100">
              Loading...
            </progress>
          </div>

          <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
              <thead>
                <tr>
                  <th>
                    <!-- select all checkbox -->
                    <input
                      type="checkbox"
                      id="select-all-jobs"
                      name="select-all-jobs"
                    />
                  </th>
                  <th>DC</th>
                  <th>Order#</th>
                  <th>Status</th>
                  <th>Requested</th>
                  <th>Completed</th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody id="history-table-body">
                <tr>
                  <td colspan="8" class="has-text-centered">
                    Loading history...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="pagination-controls" class="mt-4"></div>
        </div>
      </div>
    </section>

    <script>
      const USERDATA = {{ user_data | tojson }};

      function setLoggedInAs() {
        const loggedInAsSpan = document.getElementById("LoggedInAs");
        if (USERDATA && USERDATA.authenticated) {
          loggedInAsSpan.textContent = `Logged in: ${USERDATA.username}`;
        } else {
          loggedInAsSpan.textContent = "";
        }
      }
      function logout() {
        window.location.href = "/logout";
      }

      const RefreshIntervalMs = 3000;
      const DcLocations = {
        "00": "NASSAU CANDY DISTRIBUTORS INC",
        "01": "NASSAU CANDY SOUTH",
        "02": "NASSAU GOURMET FOODS",
        "03": "STELLAR TRACKING COMPANY",
        "04": "NASSAU CANDY MIDWEST",
        "05": "NASSAU CANDY WEST-LA",
        "06": "NC CHOCOLATE MANUFACTURING LLC",
        "07": "NASSAU CANDY SOUTHWEST",
        "08": "NASSAU CANDY WEST-SSF",
        "09": "THE CHOCOLATE INN",
        10: "NASSAU CANDY WEST-COPY",
      };
      // State management
      let CURRENT_HISTORY = [];
      let CURRENT_PAGE = 1;
      let CURRENT_FILTERS = {
        order_number: "",
        start_date: "",
        end_date: "",
        // status: "",
      };

      // Get current filter values from form inputs
      function getFilterValues() {
        return {
          order_number:
            document.getElementById("search-input")?.value.trim() || "",
          start_date: document.getElementById("start-date")?.value || "",
          end_date: document.getElementById("end-date")?.value || "",
          // status: document.getElementById('status-select')?.value || ''
          status: "",
        };
      }

      // Build query parameters for API call
      function buildQueryParams(page = 1, filters = {}) {
        const params = new URLSearchParams({
          page: page,
          per_page: 20,
        });

        if (filters.order_number) {
          params.append("order_number", filters.order_number);
        }
        if (filters.start_date) {
          params.append("start_date", filters.start_date);
        }
        if (filters.end_date) {
          params.append("end_date", filters.end_date);
        }
        if (filters.status) {
          params.append("status", filters.status);
        }

        return params;
      }

      function orderHistorySearch() {
        let searchValue = document.getElementById("search-input").value.trim();
        if (searchValue === "") {
          return;
        }

        document.getElementById("start-date").value = "";
        document.getElementById("end-date").value = "";
        CURRENT_FILTERS = {
          order_number: searchValue,
          start_date: "",
          end_date: "",
          status: "",
        };
        CURRENT_PAGE = 1;
        refreshHistory();
      }

      // Apply filters (called by filter button or form submit)
      function applyFilters() {
        CURRENT_FILTERS = getFilterValues();
        CURRENT_PAGE = 1; // Reset to first page when filtering
        refreshHistory();
      }

      // Change page (called by pagination buttons)
      function changePage(page) {
        CURRENT_PAGE = page;
        refreshHistory();
      }

      // Clear all filters
      function clearFilters() {
        document.getElementById("search-input").value = "";
        document.getElementById("start-date").value = "";
        document.getElementById("end-date").value = "";

        CURRENT_FILTERS = {
          order_number: "",
          start_date: "",
          end_date: "",
          status: "",
        };
        CURRENT_PAGE = 1;
        refreshHistory();
      }

      // Display pagination controls
      function displayPagination(pagination) {
        const paginationDiv = document.getElementById("pagination-controls");
        if (!paginationDiv) return;

        if (pagination.total_pages <= 1) {
          paginationDiv.innerHTML = "";
          return;
        }

        let paginationHTML = `
          <nav class="pagination" role="navigation" aria-label="pagination">
            <button class="pagination-previous button" 
              ${!pagination.has_prev ? "disabled" : ""} 
              onclick="changePage(${pagination.page - 1})">
              Previous
            </button>
            <button class="pagination-next button" 
              ${!pagination.has_next ? "disabled" : ""} 
              onclick="changePage(${pagination.page + 1})">
              Next
            </button>
            <ul class="pagination-list">
        `;

        // Always show first page
        paginationHTML += `
          <li>
            <button class="pagination-link button ${
              pagination.page === 1 ? "is-current" : ""
            }" 
              onclick="changePage(1)">1</button>
          </li>
        `;

        // Show ellipsis if needed
        if (pagination.page > 3) {
          paginationHTML += `<li><span class="pagination-ellipsis">&hellip;</span></li>`;
        }

        // Show pages around current page
        for (
          let i = Math.max(2, pagination.page - 1);
          i <= Math.min(pagination.total_pages - 1, pagination.page + 1);
          i++
        ) {
          paginationHTML += `
            <li>
              <button class="pagination-link button ${
                pagination.page === i ? "is-current" : ""
              }" 
                onclick="changePage(${i})">${i}</button>
            </li>
          `;
        }

        // Show ellipsis if needed
        if (pagination.page < pagination.total_pages - 2) {
          paginationHTML += `<li><span class="pagination-ellipsis">&hellip;</span></li>`;
        }

        // Always show last page (if more than 1 page)
        if (pagination.total_pages > 1) {
          paginationHTML += `
            <li>
              <button class="pagination-link button ${
                pagination.page === pagination.total_pages ? "is-current" : ""
              }" 
                onclick="changePage(${pagination.total_pages})">${
            pagination.total_pages
          }</button>
            </li>
          `;
        }

        paginationHTML += `
            </ul>
          </nav>
          <p class="has-text-centered mt-2">
            Page ${pagination.page} of ${pagination.total_pages} 
            (${pagination.total_records} total records)
          </p>
        `;

        paginationDiv.innerHTML = paginationHTML;
      }

      // Main function to load history data
      async function refreshHistory() {
        const loadingDiv = document.getElementById("history-loading");
        const tableBody = document.getElementById("history-table-body");

        loadingDiv.style.display = "block";

        try {
          const params = buildQueryParams(CURRENT_PAGE, CURRENT_FILTERS);
          const response = await fetch(`/api/history?${params}`);
          const data = await response.json();

          if (data.status === "success" && data.jobs) {
            CURRENT_HISTORY = data.jobs;

            if (data.jobs.length === 0) {
              tableBody.innerHTML = `
                <tr>
                  <td colspan="8" class="has-text-centered">No jobs found</td>
                </tr>
              `;
            } else {
              tableBody.innerHTML = data.jobs
                .map(
                  (job) => `
                <tr class="jobrow jobrow-${job.status}" is-sizer-6>
                  <td>
                    <!-- select job checkbox -->
                    <input type="checkbox" 
                      id="select-${job.job_id}" 
                      name="select-job" 
                      value="${job.job_id}" />
                  </td>
                  <td>${job.distribution_center || "-"}</td>
                  <td>${job.order_number || "-"}</td>
                  <td><span class="status-badge status-${job.status}">${
                    job.status
                  }</span></td>
                  <td>${formatDate(job.requested_at)}</td>
                  <td>${
                    job.completed_at ? formatDate(job.completed_at) : "-"
                  }</td>
                  <td>${job.result_message || "-"}</td>
                </tr>
              `
                )
                .join("");
            }

            // Display pagination controls
            if (data.pagination) {
              displayPagination(data.pagination);
            }
          } else {
            tableBody.innerHTML = `
              <tr>
                <td colspan="8" class="has-text-centered has-text-danger">
                  Error loading history
                </td>
              </tr>
            `;
          }
        } catch (error) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="8" class="has-text-centered has-text-danger">
                Error: ${error.message}
              </td>
            </tr>
          `;
        } finally {
          loadingDiv.style.display = "none";
        }
      }
    </script>

    <script>
      function loadDcLocations(inputId) {
        const dcSelects = document.querySelectorAll(`select#${inputId}`);
        const sortedKeys = Object.keys(DcLocations).sort();

        dcSelects.forEach((select) => {
          for (const code of sortedKeys) {
            const name = DcLocations[code];
            const option = document.createElement("option");
            option.value = code;
            option.textContent = `${code} - ${name}`;
            select.appendChild(option);
          }
        });
      }

      function exportSelectedJobs() {
        const selectedJobIds = Array.from(
          document.querySelectorAll('input[name="select-job"]:checked')
        ).map((checkbox) => checkbox.value);

        if (selectedJobIds.length === 0) {
          // use all jobs if none selected
          CURRENT_HISTORY.forEach((job) => {
            selectedJobIds.push(job.job_id);
          });
        }

        // Create CSV content
        let csvContent = "data:text/csv;charset=utf-8,";

        // get headers from keys of first job
        let firstJob = CURRENT_HISTORY[0];
        let headers = [];
        for (const key in firstJob) {
          headers.push(key);
        }

        csvContent += headers.join(",") + "\n";

        selectedJobIds.forEach((jobId) => {
          const job = CURRENT_HISTORY.find((j) => j.job_id === jobId);
          if (job) {
            let row = [];
            headers.forEach((header) => {
              let value = job[header];
              // escape quotes
              if (typeof value === "string") {
                value = value.replace(/"/g, '""');
                // wrap in quotes if contains comma
                if (value.indexOf(",") !== -1) {
                  value = `"${value}"`;
                }
              }
              row.push(value);
            });
            csvContent += row.join(",") + "\n";
          }
        });

        // Create download link and trigger download
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "exported_jobs.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      async function refreshPendingJobsStatus() {
        let pendingJobRows = document.querySelectorAll(".jobrow");
        let jobIds = Array.from(pendingJobRows).map((row) => {
          let returnStatus = row.dataset.status;
          const skipStatuses = ["success", "failed", "complete", "canceled"];
          if (skipStatuses.includes(returnStatus)) {
            return null;
          }
          return row.id.replace("jobrow-", "");
        });

        jobIds = jobIds.filter((id) => id !== null);

        if (jobIds.length === 0) {
          return;
        }

        document.getElementById("loading-indicator").style.display =
          "inline-block";

        fetch("/api/jobstatuses", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ job_ids: jobIds }),
        })
          .then((response) => response.json())
          .then((data) => {
            const job_ids = Object.keys(data.job_statuses);
            job_ids.forEach((job_id) => {
              const job = data.job_statuses[job_id];
              const row = document.getElementById(`jobrow-${job_id}`);
              if (row) {
                row.dataset.status = job.status;

                // set row class to blank, then add jobrow and jobrow-{status}
                row.className = "";
                row.classList.add("jobrow");
                row.classList.add(`jobrow-${job.status}`);

                const statusCell = row.querySelector("td:nth-child(5)");
                const messageCell = row.querySelector("td:nth-child(6)");
                const attemptsCell = row.querySelector("td:nth-child(7)");
                statusCell.innerHTML = `
                  <span class="status-badge status-${job.status}">${job.status}</span>`;
                messageCell.innerHTML = job.message || "-";
                attemptsCell.innerHTML = job.send_attempts || 0;
              }
            });
          })
          .catch((error) => {
            console.error("Error refreshing pending jobs status:", error);
          })
          .finally(() => {
            setTimeout(() => {
              refreshPendingJobsStatus();
            }, RefreshIntervalMs);
            document.getElementById("loading-indicator").style.display = "none";
            updateRefreshTime();
          });
      }

      function updateRefreshTime() {
        let currentTime = new Date();
        document.getElementById(
          "last-refresh-time"
        ).textContent = `${currentTime.toLocaleTimeString()}`;
      }

      function loadCurrentJobs() {
        fetch("/api/currentjobs")
          .then((response) => response.json())
          .then((data) => {
            const tableContainer = document.querySelector(
              ".tab-content#currentjobs-tab .table-container"
            );
            if (data.jobs && data.jobs.length > 0) {
              let tableHtml = `
                <table class="table is-fullwidth is-striped is-hoverable">
                  <thead>
                    <tr>
                      <th>Job Type</th>
                      <th>DC</th>
                      <th>Order #</th>
                      <th>Requested At</th>
                      <th>Status</th>
                      <th>Result Message</th>
                      <th>Attempts</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              data.jobs.forEach((job) => {
                let classNameSuffix = "jobrow-" + job.status;

                tableHtml += `
                  <tr id="jobrow-${job.job_id}" data-status="${
                  job.status
                }" class="jobrow ${classNameSuffix}">
                    <td>${job.job_type}</td>
                    <td>${job.distribution_center}</td>
                    <td>${job.order_number}</td>
                    <td>${formatDate(job.requested_at)}</td>
                    <td><span class="status-badge status-${job.status}">${
                  job.status
                }</span>
                </td>
                    <td>${job.result_message || "-"}</td>
                    <td class="send-attempts">${job.send_attempts || 0}</td>
                  </tr>
                `;
              });
              tableHtml += `
                  </tbody>
                </table>
              `;
              tableContainer.innerHTML = tableHtml;
              setTimeout(() => {
                refreshPendingJobsStatus();
              }, RefreshIntervalMs);
            } else {
              tableContainer.innerHTML = `
                <div class="notification">
                  No current jobs found.
                </div>
              `;
            }
            updateRefreshTime();
          })
          .catch((error) => {
            console.error("Error fetching current jobs:", error);
          });
      }

      function confirmSuccess(elementId, message) {
        const resultDiv = document.getElementById(elementId);
        resultDiv.innerHTML = `
          <div class="notification is-success">
            ${message}
          </div>
        `;
      }

      function confirmError(elementId, message) {
        const resultDiv = document.getElementById(elementId);
        resultDiv.innerHTML = `
          <div class="notification is-danger">
            ${message}
          </div>
        `;
      }

      function submitBatchReset() {
        const submitButton = document.getElementById("BatchResetButton");

        submitButton.classList.add("is-loading");

        const dc = document.getElementById("batch-dc").value;
        const ticketNumber = document.getElementById(
          "batch-ticket-number"
        ).value;
        const orders = document.getElementById("batch-orders").value;

        if (!dc || !ticketNumber || !orders) {
          confirmError(
            "batch-result",
            "Please fill in all required fields before submitting."
          );
          submitButton.classList.remove("is-loading");
          return;
        }

        // POST to /api/reset with JSON body
        fetch("/api/reset", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            order_number: orders,
            distribution_center: dc,
            ticket_number: ticketNumber,
            job_type: "Reset Batch Order",
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Batch Reset Response:", data);
            confirmSuccess(
              "batch-result",
              "Reset request submitted successfully."
            );
            setTimeout(() => {
              setActiveTab("currentjobs");
            }, 1200);
          })
          .catch((error) => {
            console.error("Error submitting batch reset:", error);
            confirmError(
              "batch-result",
              "Error submitting batch reset: " + error.message
            );
          })
          .finally(() => {
            submitButton.classList.remove("is-loading");
          });
      }

      // Tab switching
      document.querySelectorAll(".tabs li").forEach((tab) => {
        tab.addEventListener("click", () => {
          const targetTab = tab.dataset.tab;

          // Update active tab
          document.querySelectorAll(".tabs li").forEach((t) => {
            t.classList.remove("is-active");
          });
          tab.classList.add("is-active");

          // Update active content
          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.remove("is-active");
          });
          document
            .getElementById(`${targetTab}-tab`)
            .classList.add("is-active");

          // Refresh  when switching to history tab
          if (targetTab === "history") {
            refreshHistory();
          }

          if (targetTab === "currentjobs") {
            loadCurrentJobs();
          }
        });
      });

      function setActiveTab(tabName) {
        document.querySelectorAll(".tabs li").forEach((t) => {
          t.classList.remove("is-active");
          if (t.dataset.tab === tabName) {
            t.classList.add("is-active");
          }
        });
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("is-active");
        });
        document.getElementById(`${tabName}-tab`).classList.add("is-active");

        if (tabName === "history") {
          refreshHistory();
        }
        if (tabName === "currentjobs") {
          loadCurrentJobs();
        }
      }

      function formatDate(dateString) {
        if (!dateString) return "-";

        const utcDate = new Date(dateString);
        const localDate = new Date(
          utcDate.getTime() - utcDate.getTimezoneOffset() * 60000
        );
        const timezoneAbbr =
          new Intl.DateTimeFormat("en-US", {
            timeZoneName: "short",
          })
            .formatToParts(localDate)
            .find((part) => part.type === "timeZoneName")?.value || "";
        return localDate.toLocaleString() + ` ${timezoneAbbr}`;
      }

      // Batch order form submission
      document
        .getElementById("batch-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const resultDiv = document.getElementById("batch-result");
          resultDiv.innerHTML = "";
          submitBatchReset();
        });

      //select-all-jobs
      document
        .getElementById("select-all-jobs")
        .addEventListener("change", (e) => {
          const isChecked = e.target.checked;
          document
            .querySelectorAll('input[name="select-job"]')
            .forEach((checkbox) => {
              checkbox.checked = isChecked;
            });
        });

      setLoggedInAs();
      loadDcLocations("batch-dc");
      loadDcLocations("single-dc");
      loadCurrentJobs();
    </script>
  </body>
</html>
